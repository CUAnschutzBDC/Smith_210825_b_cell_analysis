---
title: "Analysis of healthy B cells"
author: "Kristen Wells"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    highlight: "tango"
    df_print: "paged"
    code_folding: "hide"
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  message = F, 
  warning = F,
   comment = ""
)
library(here)

#knitr::opts_knit$set(root.dir = here())
```

# Summary

```{r, include = FALSE}
library(Seurat)
library(tidyverse)
library(cowplot)
library(here)
library(scAnalysisR)
library(knitr)
library(LaCroixColoR)

# Set theme
ggplot2::theme_set(ggplot2::theme_classic(base_size = 10))

# Sample information that also includes if it is combined or not
samples <- list("healthy_bcells_1" = c("single"))

ADT <- TRUE

# Set directories
base_dir <- here()

# Change to be the cell types of the analysis
# colors from https://medialab.github.io/iwanthue/

sample_colors <- LaCroixColoR::lacroix_palette("Coconut", 3)
sample_colors <- sample_colors[1]
names(sample_colors) <- c("healthy_bcells_1")

# Read in all data
sample_list <- lapply(names(samples), function(x){
  base_dir_proj <- file.path(base_dir, "results", x)
  save_dir <- file.path(base_dir_proj, "R_analysis")
  seurat_data <- readRDS(file.path(save_dir, "rda_obj", "seurat_processed.rds"))
  unprocessed_path <- file.path(save_dir, "rda_obj", "seurat_unfilt.rds")
  doublet_path <- file.path(save_dir, "rda_obj", "seurat_doublet.rds")
  
  nColors <- length(unique(seurat_data$RNA_cluster))
  cluster_colors <- grDevices::colorRampPalette(
    RColorBrewer::brewer.pal(9, "Set1"))(nColors)
   names(cluster_colors) <- unique(seurat_data$RNA_cluster)

  return_data <- list("seurat_object" = seurat_data,
                      "seurat_unprocessed_path" = unprocessed_path,
                      "seurat_doublet_path" = doublet_path,
                      "type" = samples[[x]][1],
                      "cluster_colors" = cluster_colors,
                      "save_dir" = save_dir)
  
})

names(sample_list) <- names(samples)

```

## Quality control {.tabset}
I first check the quality of all samples by looking at the number of reads per cell, the number of features (genes) per cell, and the percent mitochondrial genes per cell. In cases where the cells were dying, we generally see a higher percent mitochondria. I like to see that most cells have less than 15% of reads mapping to mitochondrial reads.

Here it seems that most cells look pretty good. You have ~4,000-5,000 genes per cell which is amazing. I normally see closer to 3,000 genes per cell. There are definitely some cells with a really high mitochondiral percent. I filter these cells out before continuing. In general, there were fewer AT02 cells that were filtered out because of quality concerns.

My filters

* percent.mt < 10 (all cells with more thant 10% mitochondiral reads are filtered out)
* nFeature_RNA > 100 (any cells with less than 100 genes were excluded). I normally make this cutoff between 200-500, but that is too low for this dataset
* nFeature_RNA < 1500 (there were a handful of cells with many features. These are generally removed as they are suspected to be doublets)
* nCount_ADT < 1000 (Any cells with more than 1000 ADT reads were excluded. There were not many.)


```{r "plot-quality", echo = F}
if(ADT){
  quality_template <- file.path(here(),
                              "src/scripts/templates/quality_template_ADT.Rmd")
} else{
quality_template <- file.path(here(),
                              "src/scripts/templates/quality_template.Rmd")  
}


quality_chunks <- names(sample_list) %>%
  map(~knit_expand(file = quality_template, sample = .x))
```

`r knit_child(text = quality_chunks)`

## Doublet Removal {.tabset}
I next identify likely doublets using `DoubletFinder` which attempts to model what doublets would look like based on a mixing of the different clusters. The doublets identified are shown below. I filter these out before continuing the analysis.

```{r "plot-doublet", echo = F}

doublet_template <- file.path(here(),
                              "src/scripts/templates/doublet_template.Rmd")

sample_doublet <- samples[samples == "single"]

doublet_chunks <- names(sample_doublet) %>%
  map(~knit_expand(file = doublet_template, sample = .x))
```

`r knit_child(text = doublet_chunks)`

## PCA {.tabset}
I next do an initial dimensional reduction with using PCA on the top 2000 variable genes. The PCA is not too informative, but it's worth looking at a few metrics.

A) The sample - because there is only one sample, this is mostly just the shape
B) The number of UMIs seen in each cell. There is some correlation between this and PC2 so we will need to make sure this isn't captured when we make a UMAP.
C) The number of genes seen in each cell. Again, there is some correlation between this and PC2 so we will need to make sure this isn't captured when we make a UMAP.
D) The percent mitochondrial reads per cell. We don't want to see much correlation between this and either of the PCs.
```{r "plot-pca", echo = F}

pca_template <- file.path(here(),
                          "src/scripts/templates/pca_template.Rmd")

pca_chunks <- names(sample_list) %>%
  map(~knit_expand(file = pca_template, sample = .x))
```

`r knit_child(text = pca_chunks)`

## UMAP {.tabset}

I next follow the PCA with a UMAP dimensional reduction. Rather than use genes for UMAP, we use the top PCs (~30 for all of these samples). I'll plot the same metrics for UMAP as for the PCA.

A) The sample - because there is only one sample, this is mostly just the shape
B) The number of UMIs seen in each cell. There is some correlation between this and the UMAP. It could be technical or cell type specific. We can decided this based on the gene expression patterns.
C) The number of genes seen in each cell. There is a little less correlation here, but we do still see a correlation.
D) The percent mitochondrial reads per cell. There isn't much correlation here which is a good sign.
E) The clusters identified by my analysis - you can see that there isn't a lot of structure either in the UMAP or the clusters.
```{r "plot-umap", echo = F}

umap_template <- file.path(here(),
                           "src/scripts/templates/umap_template.Rmd")

umap_chunks <- names(sample_list) %>%
  map(~knit_expand(file = umap_template, sample = .x))
```

`r knit_child(text = umap_chunks)`

## Plots of ADTs {.tabset}
```{r "plot-adts", echo = F}

assay <- "CLR_ADT"
group <- "adt"
type <- "adt"

celltype_colors <- NULL

gene_template <- file.path(here(),
                           "src/scripts/templates/gene_plot_template_short.Rmd")

all_gene_template <- file.path(here(),
                           "src/scripts/templates/all_gene_template.Rmd")

adt_genes <- c("IgM", "IgD", "CXCR5.1", "CD21", "CD27.1")

genes <- adt_genes

all_gene_chunks <- names(sample_list) %>%
  map(~knit_expand(file = all_gene_template, sample = .x))
```

`r knit_child(text = all_gene_chunks)`

## Plots of RNA {.tabset}
```{r "plot-genes", echo = F}

assay <- "RNA"
group <- "rna"
type <- "rna"

celltype_colors <- NULL

gene_template <- file.path(here(),
                           "src/scripts/templates/gene_plot_template_short.Rmd")

all_gene_template <- file.path(here(),
                           "src/scripts/templates/all_gene_template.Rmd")

rna_genes <- c("CR2", # CD21,
               "CD27",
               "CXCR5",
               "IGHD", # IgD
               "IGHM" # IgM
)

genes <- rna_genes


all_gene_chunks <- names(sample_list) %>%
  map(~knit_expand(file = all_gene_template, sample = .x))
```

`r knit_child(text = all_gene_chunks)`

## Density plots ADT {.tabset}
I next looked at a density plot of each protein to see if there was any patterns that could be used to find cutoffs for identifying your subset. While there is certainly structure in the IgM and IgG that I can see, I don't see as clear of cutoffs for CD21 and CXCR5.

```{r "plot-adt-density", echo = F}
plotting_list <- adt_genes

group <- "adt"

name <- "adt"

density_template <- file.path(here(),
                           "src/scripts/templates/density_template.Rmd")

density_chunks <- names(sample_list) %>%
  map(~knit_expand(file = density_template, sample = .x, group = group))
```

`r knit_child(text = density_chunks)`

## Density plots ADT no CD27 {.tabset}
I have repeated the density plots without CD27 so it is easier to visualize patterns.
```{r "plot-adt-density-no-cd27", echo = F}
plotting_list <- c("IgM", "IgD", "CXCR5.1", "CD21")

name <- "adt_no_cd27"


density_template <- file.path(here(),
                           "src/scripts/templates/density_template.Rmd")

density_chunks <- names(sample_list) %>%
  map(~knit_expand(file = density_template, sample = .x, group = group))
```

`r knit_child(text = density_chunks)`

## Density plots RNA {.tabset}
I also tried with the RNA, but there wasn't much expression. This will probably get better with deeper sequencing.
```{r "plot-rna-density", echo = F}
plotting_list <- rna_genes

group <- "rna"

name <- "rna"

density_template <- file.path(here(),
                           "src/scripts/templates/density_template.Rmd")

density_chunks <- names(sample_list) %>%
  map(~knit_expand(file = density_template, sample = .x, group = group))
```

`r knit_child(text = density_chunks)`

